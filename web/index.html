<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
    <title>Audio/Video Mixer</title>
    <link rel="stylesheet" href="style.css" />
    <script>
      // Cache-busting hash - change this on each build
      const BUILD_HASH = "b3b586d3";

      // Add a global flag to track initialization
      window.appInitialized = false;
    </script>

    <!-- Load critical scripts in the head with defer -->
    <script src="wasm_exec.js" defer></script>
    <script src="ffmpeg.min.js" defer></script>
    <script src="debug.js?v=44c7f661" defer></script>
  </head>
  <body>
    <div class="container">
      <h1>Audio Mixer</h1>
      <p>Mix two audio files with the second as background music</p>

      <!-- Add warning for SharedArrayBuffer requirements -->
      <div
        class="warning"
        id="sabWarning"
        style="
          display: none;
          color: red;
          background: #ffeeee;
          padding: 10px;
          border-radius: 5px;
          margin-bottom: 15px;
        "
      >
        <strong>Warning:</strong> This application requires SharedArrayBuffer
        support. Please make sure you're using a recent browser and accessing
        this page via HTTPS or localhost.
      </div>

      <!-- Mode selector -->
      <div class="mode-selector" id="modeSelector">
        <h2>Select Mode</h2>
        <div class="mode-options">
          <label class="mode-option">
            <input type="radio" name="mode" id="audioOnlyRadio" checked />
            <span class="mode-label">Audio Only</span>
          </label>
          <label class="mode-option">
            <input type="radio" name="mode" id="videoWithImagesRadio" />
            <span class="mode-label">Video with Images</span>
          </label>
        </div>
      </div>

      <!-- Settings toggle button -->
      <div class="settings-toggle">
        <button id="settingsToggle" class="toggle-btn">
          <span id="settingsIcon">⚙️</span> Settings
        </button>
      </div>
      <!-- Settings panel -->
      <div id="settingsPanel" class="settings-panel">
        <h2>Output Settings</h2>
        <div class="settings-group">
          <label for="outputFormat">Format:</label>
          <select id="outputFormat">
            <option value="mp3">MP3</option>
            <option value="mp4">MP4 (Video)</option>
          </select>
        </div>
        <div class="settings-group">
          <label for="outputQuality">Quality:</label>
          <select id="outputQuality">
            <option value="1">High</option>
            <option value="2" selected>Medium</option>
            <option value="3">Low</option>
          </select>
        </div>
        <div class="settings-group">
          <label for="normalizeAudio">Normalize Audio:</label>
          <input type="checkbox" id="normalizeAudio" />
        </div>
        <div class="settings-group">
          <label for="outputDuration">Duration:</label>
          <select id="outputDuration">
            <option value="main" selected>Use Main Audio Length</option>
            <option value="bg">Use Background Audio Length</option>
            <option value="shortest">Use Shortest</option>
            <option value="longest">Use Longest</option>
            <option value="custom">Custom Duration</option>
          </select>
        </div>
        <div
          class="settings-group"
          id="customDurationContainer"
          style="display: none"
        >
          <label for="customDurationValue">Custom Duration (seconds):</label>
          <input type="number" id="customDurationValue" min="1" value="30" />
        </div>

        <!-- Video Settings -->
        <div id="videoSettingsContainer" style="display: none">
          <h3>Video Settings</h3>
          <div class="settings-group">
            <label for="videoSize">Video Size:</label>
            <select id="videoSize">
              <option value="instagram">Instagram (1080x1080)</option>
              <option value="youtube" selected>YouTube (1920x1080)</option>
              <option value="tiktok">TikTok (1080x1920)</option>
              <option value="custom">Custom Size</option>
            </select>
          </div>
          <div
            class="settings-group"
            id="customVideoSizeContainer"
            style="display: none"
          >
            <label for="customVideoWidth">Width:</label>
            <input
              type="number"
              id="customVideoWidth"
              min="100"
              max="3840"
              value="1920"
            />
            <label for="customVideoHeight">Height:</label>
            <input
              type="number"
              id="customVideoHeight"
              min="100"
              max="2160"
              value="1080"
            />
          </div>
        </div>
      </div>

      <div class="file-inputs">
        <h2>Audio Files</h2>
        <div class="input-group">
          <label for="mainAudio">Main Audio:</label>
          <input type="file" id="mainAudio" accept="audio/*" />
        </div>
        <div class="input-group">
          <label for="bgAudio">Background Audio:</label>
          <input type="file" id="bgAudio" accept="audio/*" />
        </div>
        <div class="input-group">
          <label for="bgVolume">Background Volume:</label>
          <input type="range" id="bgVolume" min="0" max="100" value="30" />
          <span id="volumeValue">30%</span>
        </div>
      </div>

      <!-- Image uploads container -->
      <div
        class="image-uploads"
        id="imageUploadsContainer"
        style="display: none"
      >
        <h2>Images for Video</h2>
        <p>Add images to create a slideshow video with your audio</p>
        <div class="image-uploads-controls">
          <button type="button" id="addImageButton">Add Image</button>
          <button type="button" id="distributeTimeButton">
            Distribute Time Evenly
          </button>
        </div>
        <!-- Image upload items will be added here dynamically -->
      </div>

      <div class="controls">
        <button id="mixButton" disabled>Mix Audio</button>
      </div>

      <div class="progress-container" style="display: none">
        <div class="progress-bar-container">
          <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="progressText">Processing: 0%</div>
      </div>

      <div class="result" id="resultContainer" style="display: none">
        <h2>Result</h2>
        <div id="resultMediaContainer"></div>
        <a id="downloadLink" href="#" download="mixed_audio.mp3"
          >Download MP3</a
        >
      </div>

      <div class="logs" id="logs"></div>
    </div>

    <!-- Load application scripts in the correct order -->
    <script>
      // Function to load scripts with cache-busting
      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = src + "?v=" + BUILD_HASH;
          script.onload = resolve;
          script.onerror = reject;
          document.body.appendChild(script);
        });
      }

      // Replace the existing loadAllScripts function with this updated version
      async function loadAllScripts() {
        try {
          // Load script.js first so init function is available early
          console.log("Loading script.js...");
          await loadScript("script.js");
          console.log("script.js loaded");

          console.log("Loading wasm.js...");
          await loadScript("wasm.js");
          console.log("wasm.js loaded");

          console.log("Loading settings.js...");
          await loadScript("settings.js");
          console.log("settings.js loaded");

          console.log("Loading video-ui.js...");
          await loadScript("video-ui.js");
          console.log("video-ui.js loaded");

          console.log("Loading ui.js...");
          await loadScript("ui.js");
          console.log("ui.js loaded");

          console.log("All scripts loaded successfully");

          // Manually initialize the application
          if (typeof window.init === "function") {
            console.log("Manually calling init() function");
            window.init();
          } else {
            console.error("init function not found after loading all scripts");
            console.error(
              "Available global functions:",
              Object.keys(window).filter(
                (key) => typeof window[key] === "function"
              )
            );
          }
        } catch (error) {
          console.error("Error loading scripts:", error);
        }
      }

      // Wait for DOM content to be loaded
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM content loaded, initializing application");

        // Initialize debug system if available
        if (
          window.debugSystem &&
          typeof window.debugSystem.init === "function"
        ) {
          console.log("Initializing debug system from DOMContentLoaded");
          window.debugSystem.init();
        }

        // Load all scripts
        loadAllScripts();
      });
    </script>
  </body>
</html>
